@using CarCenterContracts.ViewModels;
@using CarCenterDataModels.Enums;

@model OrderViewModel

@{
    ViewData["Title"] = "CreateOrder";
    ViewBag.Presales = Model.OrderPresales;
    ViewBag.Cars = Model.Cars;
}
<div class="text-center">
    <h2 class="display-4">Создание заказа</h2>
</div>
<form id="orderForm" method="post">
    <div class="row">
        <div class="col-4">Тип оплаты:</div>
        <div class="col-8">
            <select name="PaymentType" id="PaymentType" value="@Model.PaymentType">
                @foreach (var value in Enum.GetValues(typeof(PaymentType)))
                {
                    <option value="@value" selected="@(value.Equals(Model.PaymentType) ? "selected" : null)">@value</option>
                }
            </select>
            <span id="PaymentTypeError" class="text-danger"></span>
        </div>
    </div>
    @if (Model.Id != 0)
    {
        <div class="row">
            <div class="col-4">Статус оплаты:</div>
            <div class="col-8">
                <select name="PaymentStatus" id="PaymentStatus" value="@Model.PaymentStatus">
                    @foreach (var value in Enum.GetValues(typeof(PaymentStatus)))
                    {
                        <option value="@value" selected="@(value.Equals(Model.PaymentStatus) ? "selected" : null)">@value</option>
                    }
                </select>
                <span id="PaymentStatusError" class="text-danger"></span>
            </div>
        </div>
    }
    <div class="row">
        <div class="col-4">ФИО покупателя:</div>
        <div class="col-8">
            <input type="text" name="BuyerFCS" id="BuyerFCS" value="@Model.BuyerFCS" />
            <span id="BuyerFCSError" class="text-danger"></span>
        </div>
    </div>
    <div class="container">
        <div>Предпродажные работы</div>
        <div class="table-responsive-lg">
            <table id="presalesTable" class="display">
                <thead>
                    <tr>
                        <th>ID предпродажной</th>
                        <th>     </th>
                        <th>Стоимость</th>
                        <th>     </th>
                        <th>Удалить</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var presale in ViewBag.Presales)
                    {
                        <tr data-presale-id="@presale.Value.Id">
                            <td>
                                <input type="hidden" name="presaleIds" value="@presale.Value.Id" />@presale.Value.Id
                            </td>
                            <th>     </th>
                            <td class="presale-price" data-price="@presale.Value.Price">@presale.Value.Price</td>
                            <th>     </th>
                            <td><button type="button" class="deletePresale" data-bundling-id="@presale.Value.Id">Удалить</button></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <select id="presaleSelect" class="form-control">
            <option value="">Выберите работу</option>
            @foreach (var presale in ViewBag.AllPresales)
            {
                <option value="@presale.Id" data-price="@presale.Price">Работа @presale.Id</option>
            }
        </select>
        <button type="button" id="addPresale" class="btn btn-secondary">Добавить работу</button>
    </div>
    <div class="container">
        <div>Машины</div>
        <div class="table-responsive-lg">
            <table id="carsTable" class="display">
                <thead>
                    <tr>
                        <th>ID машины</th>
                        <th>     </th>
                        <th>Стоимость</th>
                        <th>     </th>
                        <th>Удалить</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var car in ViewBag.Cars)
                    {
                        <tr data-car-id="@car.Value.Id">
                            <td>
                                <input type="hidden" name="carIds" value="@car.Value.Id" />@car.Value.Id
                            </td>
                            <th>     </th>
                            <td class="car-price" data-price="@car.Value.Price">@car.Value.Price</td>
                            <th>     </th>
                            <td><button type="button" class="deleteCar" data-car-id="@car.Value.Id">Удалить</button></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <select id="carSelect" class="form-control">
            <option value="">Выберите машину</option>
            @foreach (var car in ViewBag.AllCars)
            {
                <option value="@car.Id" data-price="@car.Price">Машина @car.Id</option>
            }
        </select>
        <button type="button" id="addCar" class="btn btn-secondary">Добавить машину</button>
    </div>
    <div class="row">
        <div class="col-4">Сумма:</div>
        <div class="col-8"><input type="text" id="Sum" name="Sum" readonly /></div>
    </div>
    <div class="row">
        <div class="col-8"></div>
        <div class="col-4"><input type="submit" value="Сохранить" class="btn btn-primary" /></div>
    </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<script>
    $(document).ready(function () {
        function updateSum() {
            var Sum = 0;
            $('#presalesTable tbody tr').each(function () {
                var pricebd = $(this).find('.presale-price').data('price');
                Sum += parseFloat(pricebd);
            });
            $('#carsTable tbody tr').each(function () {
                var pricecar = $(this).find('.car-price').data('price');
                Sum += parseFloat(pricecar);
            });
            $('#Sum').val(Sum.toFixed(2));
        }

        $(document).on('click', '.deleteCar', function () {
            var row = $(this).closest('tr');
            row.remove();
            updateSum();
        });
        $(document).on('click', '.deletePresale', function () {
            var row = $(this).closest('tr');
            row.remove();
            updateSum();
        });
        $('#addPresale').click(function () {
            var selectedPresale = $('#presaleSelect option:selected');
            if (selectedPresale.val()) {
                var presaleId = selectedPresale.val();
                var exists = false;
                $('#presalesTable tbody tr').each(function () {
                    if ($(this).data('presale-id') == presaleId) {
                        exists = true;
                        return false;
                    }
                });
                if (exists) {
                    alert('Эта работа уже добавлена.');
                    return;
                }

                var presaleName = selectedPresale.text();
                var presalePrice = selectedPresale.data('price');

                var newRow = `
                                                <tr data-presale-id="${presaleId}">
                                            <td>
                                                        <input type="hidden" name="presaleIds" value="${presaleId}" />
                                                    ${presaleId}
                                            </td>
                                            <th>     </th>
                                                        <td class="presale-price" data-price="${presalePrice}">${presalePrice}</td>
                                            <th>     </th>
                                                        <td><button type="button" class="deletePresale" data-presale-id="${presaleId}">Удалить</button></td>
                                        </tr>
                                    `;
                $('#presalesTable tbody').append(newRow);

                $('.deletePresale').off('click').on('click', function () {
                    var row = $(this).closest('tr');
                    row.remove();
                    updateSum();
                });

                $('#presaleSelect').val('');

                updateSum();
            } else {
                alert('Выберите работу для добавления');
            }
        });
        $('#addCar').click(function () {
            var selectedCar = $('#carSelect option:selected');
            if (selectedCar.val()) {
                var carId = selectedCar.val();
                var exists = false;
                $('#carsTable tbody tr').each(function () {
                    if ($(this).data('car-id') == carId) {
                        exists = true;
                        return false;
                    }
                });
                if (exists) {
                    alert('Эта машина уже добавлена.');
                    return;
                }

                var carName = selectedCar.text();
                var carPrice = selectedCar.data('price');

                var newRow = `
                                                    <tr data-car-id="${carId}">
                                                <td>
                                                            <input type="hidden" name="carIds" value="${carId}" />
                                                        ${carId}
                                                </td>
                                                <th>     </th>
                                                            <td class="car-price" data-price="${carPrice}">${carPrice}</td>
                                                <th>     </th>
                                                            <td><button type="button" class="deleteCar" data-car-id="${carId}">Удалить</button></td>
                                            </tr>
                                        `;
                $('#carsTable tbody').append(newRow);

                $('.deleteCar').off('click').on('click', function () {
                    var row = $(this).closest('tr');
                    row.remove();
                    updateSum();
                });

                $('#carSelect').val('');

                updateSum();
            } else {
                alert('Выберите машину для добавления');
            }
        });

        $('#orderForm').submit(function (event) {
            var PaymentType = $('#PaymentType').val();
            var PaymentStatus = $('#PaymentStatus').val();
            var BuyerFCS = $('#BuyerFCS').val();
            var isValid = true;

            $('#PaymentTypeError').text('');
            $('#PaymentStatusError').text('');
            $('#BuyerFCSError').text('');
            var totalCars = $('#carsTable tbody tr').length;
            if (totalCars == 0) {
                alert('Пожалуйста, добавьте хотя бы одну машину.');
                isValid = false;
            }
            var totalPresales = $('#presalesTable tbody tr').length;
            if (totalPresales == 0) {
                alert('Пожалуйста, добавьте хотя бы одну работу.');
                isValid = false;
            }

            if (!isValid) {
                event.preventDefault();
            }
        });

        updateSum();
    });
</script>

